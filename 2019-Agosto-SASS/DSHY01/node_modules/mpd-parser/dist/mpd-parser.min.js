/*! @name mpd-parser @version 0.8.1 @license Apache-2.0 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("global/window")):"function"==typeof define&&define.amd?define(["exports","global/window"],t):t(e.mpdParser={},e.window)}(this,function(e,t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var r=function(e){return!!e&&"object"==typeof e},n=function e(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return n.reduce(function(t,n){return Object.keys(n).forEach(function(i){Array.isArray(t[i])&&Array.isArray(n[i])?t[i]=t[i].concat(n[i]):r(t[i])&&r(n[i])?t[i]=e(t[i],n[i]):t[i]=n[i]}),t},{})},i=function(e){return e.reduce(function(e,t){return e.concat(t)},[])},a=function(e){if(!e.length)return[];for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return t},u="INVALID_NUMBER_OF_PERIOD",o="DASH_EMPTY_MANIFEST",s="DASH_INVALID_XML",d="NO_BASE_URL",c="SEGMENT_TIME_UNSPECIFIED",l="UNSUPPORTED_UTC_TIMING_SCHEME";"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var m,f=(function(e,t){var r,n,i,a,u;r=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/\?#]*\/)*.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,n=/^([^\/?#]*)(.*)$/,i=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,u={buildAbsoluteURL:function(e,t,r){if(r=r||{},e=e.trim(),!(t=t.trim())){if(!r.alwaysNormalize)return e;var i=u.parseURL(e);if(!i)throw new Error("Error trying to parse base URL.");return i.path=u.normalizePath(i.path),u.buildURLFromParts(i)}var a=u.parseURL(t);if(!a)throw new Error("Error trying to parse relative URL.");if(a.scheme)return r.alwaysNormalize?(a.path=u.normalizePath(a.path),u.buildURLFromParts(a)):t;var o=u.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var s=n.exec(o.path);o.netLoc=s[1],o.path=s[2]}o.netLoc&&!o.path&&(o.path="/");var d={scheme:o.scheme,netLoc:a.netLoc,path:null,params:a.params,query:a.query,fragment:a.fragment};if(!a.netLoc&&(d.netLoc=o.netLoc,"/"!==a.path[0]))if(a.path){var c=o.path,l=c.substring(0,c.lastIndexOf("/")+1)+a.path;d.path=u.normalizePath(l)}else d.path=o.path,a.params||(d.params=o.params,a.query||(d.query=o.query));return null===d.path&&(d.path=r.alwaysNormalize?u.normalizePath(a.path):a.path),u.buildURLFromParts(d)},parseURL:function(e){var t=r.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(i,"");e.length!==(e=e.replace(a,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=u}(m={exports:{}},m.exports),m.exports),p=function(e,r){return/^[a-z]+:/i.test(r)?r:(/\/\//i.test(e)||(e=f.buildAbsoluteURL(t.location.href,e)),f.buildAbsoluteURL(e,r))},v=function(e){var t=e.baseUrl,r=void 0===t?"":t,n=e.source,i=void 0===n?"":n,a=e.range,u=void 0===a?"":a,o=e.indexRange,s=void 0===o?"":o,d={uri:i,resolvedUri:p(r||"",i)};if(u||s){var c=(u||s).split("-"),l=parseInt(c[0],10),m=parseInt(c[1],10);d.byterange={length:m-l+1,offset:l}}return d},h={static:function(e){var t=e.duration,r=e.timescale,n=void 0===r?1:r,i=e.sourceDuration;return{start:0,end:Math.ceil(i/(t/n))}},dynamic:function(e){var t=e.NOW,r=e.clientOffset,n=e.availabilityStartTime,i=e.timescale,a=void 0===i?1:i,u=e.duration,o=e.start,s=void 0===o?0:o,d=e.minimumUpdatePeriod,c=void 0===d?0:d,l=e.timeShiftBufferDepth,m=void 0===l?1/0:l,f=(t+r)/1e3,p=n+s,v=f+c-p,h=Math.ceil(v*a/u),g=Math.floor((f-p-m)*a/u),b=Math.floor((f-p)*a/u);return{start:Math.max(0,g),end:Math.min(h,b)}}},g=function(e){var t=e.type,r=void 0===t?"static":t,n=e.duration,i=e.timescale,a=void 0===i?1:i,u=e.sourceDuration,o=h[r](e),s=function(e,t){for(var r=[],n=e;n<t;n++)r.push(n);return r}(o.start,o.end).map(function(e){return function(t,r){var n=e.duration,i=e.timescale,a=void 0===i?1:i,u=e.periodIndex,o=e.startNumber;return{number:(void 0===o?1:o)+t,duration:n/a,timeline:u,time:r*n}}}(e));if("static"===r){var d=s.length-1;s[d].duration=u-n/a*d}return s},b=function(e){var t=e.baseUrl,r=e.initialization,n=void 0===r?{}:r,i=e.sourceDuration,a=e.timescale,u=void 0===a?1:a,o=e.indexRange,s=void 0===o?"":o,c=e.duration;if(!t)throw new Error(d);var l=v({baseUrl:t,source:n.sourceURL,range:n.range}),m=v({baseUrl:t,source:t,indexRange:s});if(m.map=l,c){var f=g(e);f.length&&(m.duration=f[0].duration,m.timeline=f[0].timeline)}else i&&(m.duration=i/u,m.timeline=0);return m.number=0,[m]},U=function(e,t,r){for(var n=e.sidx.map?e.sidx.map:null,i=e.sidx.duration,a=e.timeline||0,u=e.sidx.byterange,o=u.offset+u.length,s=t.timescale,d=t.references.filter(function(e){return 1!==e.referenceType}),c=[],l=o+t.firstOffset,m=0;m<d.length;m++){var f=t.references[m],p=f.referencedSize,v=f.subsegmentDuration,h=b({baseUrl:r,timescale:s,timeline:a,periodIndex:a,duration:v,sourceDuration:i,indexRange:l+"-"+(l+p-1)})[0];n&&(h.map=n),c.push(h),l+=p}return e.segments=c,e},y=function(e){var t;return(t=e.reduce(function(e,t){var r,n=t.attributes.id+(t.attributes.lang||"");e[n]?(t.segments[0]&&(t.segments[0].discontinuity=!0),(r=e[n].segments).push.apply(r,t.segments),t.attributes.contentProtection&&(e[n].attributes.contentProtection=t.attributes.contentProtection)):e[n]=t;return e},{}),Object.keys(t).map(function(e){return t[e]})).map(function(e){var t,r;return e.discontinuityStarts=(t=e.segments,r="discontinuity",t.reduce(function(e,t,n){return t[r]&&e.push(n),e},[])),e})},I=function(e,t){if(void 0===t&&(t={}),!Object.keys(t).length)return e;for(var r in e){var n=e[r];if(n.sidx){var i=n.sidx.uri+"-"+(u=n.sidx.byterange,o=void 0,o=u.offset+u.length-1,u.offset+"-"+o),a=t[i]&&t[i].sidx;n.sidx&&a&&U(n,a,n.sidx.resolvedUri)}}var u,o;return e},D=function(e){var t,r=e.attributes,n=e.segments,i=e.sidx,a={attributes:(t={NAME:r.id,AUDIO:"audio",SUBTITLES:"subs",RESOLUTION:{width:r.width,height:r.height},CODECS:r.codecs,BANDWIDTH:r.bandwidth},t["PROGRAM-ID"]=1,t),uri:"",endList:"static"===(r.type||"static"),timeline:r.periodIndex,resolvedUri:"",targetDuration:r.duration,segments:n,mediaSequence:n.length?n[0].number:1};return r.contentProtection&&(a.contentProtection=r.contentProtection),i&&(a.sidx=i),a},w=function(e,t){var r;if(void 0===t&&(t={}),!e.length)return{};var n=e[0].attributes,i=n.sourceDuration,a=n.minimumUpdatePeriod,u=void 0===a?0:a,o=y(e.filter(function(e){var t=e.attributes;return"video/mp4"===t.mimeType||"video"===t.contentType})).map(D),s=y(e.filter(function(e){var t=e.attributes;return"audio/mp4"===t.mimeType||"audio"===t.contentType})),d=e.filter(function(e){var t=e.attributes;return"text/vtt"===t.mimeType||"text"===t.contentType}),c={allowCache:!0,discontinuityStarts:[],segments:[],endList:!0,mediaGroups:(r={AUDIO:{},VIDEO:{}},r["CLOSED-CAPTIONS"]={},r.SUBTITLES={},r),uri:"",duration:i,playlists:I(o,t),minimumUpdatePeriod:1e3*u};return s.length&&(c.mediaGroups.AUDIO.audio=function(e,t){var r;void 0===t&&(t={});var n=e.reduce(function(e,n){var i=n.attributes.role&&n.attributes.role.value||"",a=n.attributes.lang||"",u="main";if(a){var o=i?" ("+i+")":"";u=""+n.attributes.lang+o}return e[u]&&e[u].playlists[0].attributes.BANDWIDTH>n.attributes.bandwidth?e:(e[u]={language:a,autoselect:!0,default:"main"===i,playlists:I([function(e){var t,r=e.attributes,n=e.segments,i=e.sidx,a={attributes:(t={NAME:r.id,BANDWIDTH:r.bandwidth,CODECS:r.codecs},t["PROGRAM-ID"]=1,t),uri:"",endList:"static"===(r.type||"static"),timeline:r.periodIndex,resolvedUri:"",targetDuration:r.duration,segments:n,mediaSequence:n.length?n[0].number:1};return r.contentProtection&&(a.contentProtection=r.contentProtection),i&&(a.sidx=i),a}(n)],t),uri:""},void 0===r&&"main"===i&&((r=n).default=!0),e)},{});r||(n[Object.keys(n)[0]].default=!0);return n}(s,t)),d.length&&(c.mediaGroups.SUBTITLES.subs=function(e,t){return void 0===t&&(t={}),e.reduce(function(e,r){var n,i,a,u,o=r.attributes.lang||"text";return e[o]?e:(e[o]={language:o,default:!1,autoselect:!1,playlists:I([(n=r,a=n.attributes,u=n.segments,void 0===u&&(u=[{uri:a.baseUrl,timeline:a.periodIndex,resolvedUri:a.baseUrl||"",duration:a.sourceDuration,number:0}],a.duration=a.sourceDuration),{attributes:(i={NAME:a.id,BANDWIDTH:a.bandwidth},i["PROGRAM-ID"]=1,i),uri:"",endList:"static"===(a.type||"static"),timeline:a.periodIndex,resolvedUri:a.baseUrl||"",targetDuration:a.duration,segments:u,mediaSequence:u.length?u[0].number:1})],t),uri:""},e)},{})}(d,t)),c},x=function(e,t,r){var n=e.NOW,i=e.clientOffset,a=e.availabilityStartTime,u=e.timescale,o=void 0===u?1:u,s=e.start,d=void 0===s?0:s,c=e.minimumUpdatePeriod,l=(n+i)/1e3+(void 0===c?0:c)-(a+d);return Math.ceil((l*o-t)/r)},L=function(e,t){for(var r=e.type,n=void 0===r?"static":r,i=e.minimumUpdatePeriod,a=void 0===i?0:i,u=e.media,o=void 0===u?"":u,s=e.sourceDuration,d=e.timescale,c=void 0===d?1:d,l=e.startNumber,m=void 0===l?1:l,f=e.periodIndex,p=[],v=-1,h=0;h<t.length;h++){var g=t[h],b=g.d,U=g.r||0,y=g.t||0;v<0&&(v=y),y&&y>v&&(v=y);var I=void 0;if(U<0){var D=h+1;I=D===t.length?"dynamic"===n&&a>0&&o.indexOf("$Number$")>0?x(e,v,b):(s*c-v)/b:(t[D].t-v)/b}else I=U+1;for(var w=m+p.length+I,L=m+p.length;L<w;)p.push({number:L,duration:b/c,time:v,timeline:f}),v+=b,L++}return p},R=/\$([A-z]*)(?:(%0)([0-9]+)d)?\$/g,E=function(e,t){return e.replace(R,function(e){return function(t,r,n,i){if("$$"===t)return"$";if(void 0===e[r])return t;var a=""+e[r];return"RepresentationID"===r?a:(i=n?parseInt(i,10):1,a.length>=i?a:""+new Array(i-a.length+1).join("0")+a)}}(t))},P=function(e,t){var r={RepresentationID:e.id,Bandwidth:e.bandwidth||0},n=e.initialization,i=void 0===n?{sourceURL:"",range:""}:n,a=v({baseUrl:e.baseUrl,source:E(i.sourceURL,r),range:i.range});return function(e,t){return e.duration||t?e.duration?g(e):L(e,t):[{number:e.startNumber||1,duration:e.sourceDuration,time:0,timeline:e.periodIndex}]}(e,t).map(function(t){r.Number=t.number,r.Time=t.time;var n=E(e.media||"",r);return{uri:n,timeline:t.timeline,duration:t.duration,resolvedUri:p(e.baseUrl||"",n),map:a,number:t.number}})},T=function(e,t){var r=e.duration,n=e.segmentUrls,i=void 0===n?[]:n;if(!r&&!t||r&&t)throw new Error(c);var a,u=i.map(function(t){return function(e,t){var r=e.baseUrl,n=e.initialization,i=void 0===n?{}:n,a=v({baseUrl:r,source:i.sourceURL,range:i.range}),u=v({baseUrl:r,source:t.media,range:t.mediaRange});return u.map=a,u}(e,t)});return r&&(a=g(e)),t&&(a=L(e,t)),a.map(function(e,t){if(u[t]){var r=u[t];return r.timeline=e.timeline,r.duration=e.duration,r.number=e.number,r}}).filter(function(e){return e})},S=function(e){var t,r,i=e.attributes,a=e.segmentInfo;a.template?(r=P,t=n(i,a.template)):a.base?(r=b,t=n(i,a.base)):a.list&&(r=T,t=n(i,a.list));var u={attributes:i};if(!r)return u;var o=r(t,a.timeline);if(t.duration){var s=t,d=s.duration,c=s.timescale,l=void 0===c?1:c;t.duration=d/l}else o.length?t.duration=o.reduce(function(e,t){return Math.max(e,Math.ceil(t.duration))},0):t.duration=0;return u.attributes=t,u.segments=o,a.base&&t.indexRange&&(u.sidx=o[0],u.segments=[]),u},N=function(e,t){return a(e.childNodes).filter(function(e){return e.tagName===t})},O=function(e){return e.textContent.trim()},A=function(e){var t=/P(?:(\d*)Y)?(?:(\d*)M)?(?:(\d*)D)?(?:T(?:(\d*)H)?(?:(\d*)M)?(?:([\d.]*)S)?)?/.exec(e);if(!t)return 0;var r=t.slice(1),n=r[0],i=r[1],a=r[2],u=r[3],o=r[4],s=r[5];return 31536e3*parseFloat(n||0)+2592e3*parseFloat(i||0)+86400*parseFloat(a||0)+3600*parseFloat(u||0)+60*parseFloat(o||0)+parseFloat(s||0)},M={mediaPresentationDuration:function(e){return A(e)},availabilityStartTime:function(e){return/^\d+-\d+-\d+T\d+:\d+:\d+(\.\d+)?$/.test(t=e)&&(t+="Z"),Date.parse(t)/1e3;var t},minimumUpdatePeriod:function(e){return A(e)},timeShiftBufferDepth:function(e){return A(e)},start:function(e){return A(e)},width:function(e){return parseInt(e,10)},height:function(e){return parseInt(e,10)},bandwidth:function(e){return parseInt(e,10)},startNumber:function(e){return parseInt(e,10)},timescale:function(e){return parseInt(e,10)},duration:function(e){var t=parseInt(e,10);return isNaN(t)?A(e):t},d:function(e){return parseInt(e,10)},t:function(e){return parseInt(e,10)},r:function(e){return parseInt(e,10)},DEFAULT:function(e){return e}},z=function(e){return e&&e.attributes?a(e.attributes).reduce(function(e,t){var r=M[t.name]||M.DEFAULT;return e[t.name]=r(t.value),e},{}):{}};var B={"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b":"org.w3.clearkey","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed":"com.widevine.alpha","urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95":"com.microsoft.playready","urn:uuid:f239e769-efa3-4850-9c16-a903c6932efb":"com.adobe.primetime"},C=function(e,t){return t.length?i(e.map(function(e){return t.map(function(t){return p(e,O(t))})})):e},F=function(e){var t=N(e,"SegmentTemplate")[0],r=N(e,"SegmentList")[0],i=r&&N(r,"SegmentURL").map(function(e){return n({tag:"SegmentURL"},z(e))}),a=N(e,"SegmentBase")[0],u=r||t,o=u&&N(u,"SegmentTimeline")[0],s=r||a||t,d=s&&N(s,"Initialization")[0],c=t&&z(t);c&&d?c.initialization=d&&z(d):c&&c.initialization&&(c.initialization={sourceURL:c.initialization});var l={template:c,timeline:o&&N(o,"S").map(function(e){return z(e)}),list:r&&n(z(r),{segmentUrls:i,initialization:z(d)}),base:a&&n(z(a),{initialization:z(d)})};return Object.keys(l).forEach(function(e){l[e]||delete l[e]}),l},_=function(e){return e.reduce(function(e,r){var n=z(r),i=B[n.schemeIdUri];if(i){e[i]={attributes:n};var a=N(r,"cenc:pssh")[0];if(a){var u=O(a),o=u&&function(e){for(var r=t.atob(e),n=new Uint8Array(r.length),i=0;i<r.length;i++)n[i]=r.charCodeAt(i);return n}(u);e[i].pssh=o}}return e},{})},j=function(e,t,r){return function(a){var u=z(a),o=C(t,N(a,"BaseURL")),s=N(a,"Role")[0],d={role:z(s)},c=n(e,u,d),l=_(N(a,"ContentProtection"));Object.keys(l).length&&(c=n(c,{contentProtection:l}));var m=F(a),f=N(a,"Representation"),p=n(r,m);return i(f.map(function(e,t,r){return function(i){var a=N(i,"BaseURL"),u=C(t,a),o=n(e,z(i)),s=F(i);return u.map(function(e){return{segmentInfo:n(r,s),attributes:n(o,{baseUrl:e})}})}}(c,o,p)))}},q=function(e,r){void 0===r&&(r={});var a=r,o=a.manifestUri,s=void 0===o?"":o,d=a.NOW,c=void 0===d?Date.now():d,l=a.clientOffset,m=void 0===l?0:l,f=N(e,"Period");if(!f.length)throw new Error(u);var p=z(e),v=C([s],N(e,"BaseURL"));return p.sourceDuration=p.mediaPresentationDuration||0,p.NOW=c,p.clientOffset=m,i(f.map(function(e,r){return function(a,u){var o=C(r,N(a,"BaseURL")),s=z(a),d=parseInt(s.id,10),c=t.isNaN(d)?u:d,l=n(e,{periodIndex:c}),m=N(a,"AdaptationSet"),f=F(a);return i(m.map(j(l,o,f)))}}(p,v)))},k=function(e){if(""===e)throw new Error(o);var r=(new t.DOMParser).parseFromString(e,"application/xml"),n=r&&"MPD"===r.documentElement.tagName?r.documentElement:null;if(!n||n&&n.getElementsByTagName("parsererror").length>0)throw new Error(s);return n};e.VERSION="0.8.1",e.parse=function(e,t){return void 0===t&&(t={}),w(q(k(e),t).map(S),t.sidxMapping)},e.parseUTCTiming=function(e){return function(e){var t=N(e,"UTCTiming")[0];if(!t)return null;var r=z(t);switch(r.schemeIdUri){case"urn:mpeg:dash:utc:http-head:2014":case"urn:mpeg:dash:utc:http-head:2012":r.method="HEAD";break;case"urn:mpeg:dash:utc:http-xsdate:2014":case"urn:mpeg:dash:utc:http-iso:2014":case"urn:mpeg:dash:utc:http-xsdate:2012":case"urn:mpeg:dash:utc:http-iso:2012":r.method="GET";break;case"urn:mpeg:dash:utc:direct:2014":case"urn:mpeg:dash:utc:direct:2012":r.method="DIRECT",r.value=Date.parse(r.value);break;case"urn:mpeg:dash:utc:http-ntp:2014":case"urn:mpeg:dash:utc:ntp:2014":case"urn:mpeg:dash:utc:sntp:2014":default:throw new Error(l)}return r}(k(e))},Object.defineProperty(e,"__esModule",{value:!0})});
